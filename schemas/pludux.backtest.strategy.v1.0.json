{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "$id": "http://pludux.com/schemas/pludux.backtest.strategy.v1.0.json",
  "title": "Pludux Backtest Strategy Schema",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "integer",
      "minimum": 1
    },
    "series": {
      "type": "object",
      "patternProperties": {
        "^[a-z][a-z0-9_]*$": {
          "$ref": "#/definitions/method"
        }
      }
    },
    "risk": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "method": {
          "enum": [
            "ATR",
            "PERCENTAGE",
            "VALUE"
          ]
        },
        "atr": {
          "type": "object",
          "properties": {
            "period": {
              "type": "integer"
            },
            "multiplier": {
              "type": "number"
            }
          },
          "required": [
            "period",
            "multiplier"
          ]
        },
        "percentage": {
          "type": "number"
        },
        "value": {
          "type": "number"
        }
      }
    },
    "stopLoss": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "isTrailing": {
              "type": "boolean"
            }
          }
        },
        {
          "type": "boolean"
        }
      ]
    },
    "takeProfit": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "riskMultiplier": {
              "type": "number"
            }
          }
        },
        {
          "type": "boolean"
        }
      ]
    },
    "longPosition": {
      "$ref": "#/definitions/tradePosition"
    },
    "shortPosition": {
      "$ref": "#/definitions/tradePosition"
    }
  },
  "required": [
    "risk"
  ],
  "definitions": {
    "tradePosition": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "entry": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "signal": {
              "$ref": "#/definitions/filterAsParameter"
            }
          },
          "required": [
            "signal"
          ]
        },
        "exit": {
          "type": "object",
          "properties": {
            "signal": {
              "$ref": "#/definitions/filterAsParameter"
            }
          },
          "required": [
            "signal"
          ]
        }
      },
      "required": [
        "entry"
      ]
    },
    "methodAsParameter": {
      "oneOf": [
        {
          "type": "number"
        },
        {
          "type": "string"
        },
        {
          "$ref": "#/definitions/method"
        }
      ]
    },
    "baseMethod": {
      "type": "object",
      "properties": {
        "method": {
          "type": "string",
          "pattern": "^[A-Z_]+$"
        }
      },
      "required": [
        "method"
      ]
    },
    "quoteMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "enum": [
                "OPEN",
                "HIGH",
                "LOW",
                "CLOSE",
                "VOLUME"
              ]
            }
          }
        }
      ]
    },
    "referenceMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "REFERENCE"
            },
            "name": {
              "type": "string"
            },
            "offset": {
              "type": "integer"
            }
          },
          "required": [
            "name"
          ]
        }
      ]
    },
    "selectOutputMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "SELECT_OUTPUT"
            },
            "name": {
              "type": "string",
              "enum": [
                "upper-band",
                "middle-band",
                "lower-band",
                "k-percent",
                "d-percent",
                "macd-line",
                "signal-line",
                "histogram"
              ]
            },
            "source": {
              "$ref": "#/definitions/methodAsParameter"
            }
          },
          "required": [
            "name",
            "source"
          ]
        }
      ]
    },
    "lookbackMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "LOOKBACK"
            },
            "source": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "period": {
              "type": "integer",
              "minimum": 0
            }
          },
          "required": [
            "source",
            "period"
          ]
        }
      ]
    },
    "valueMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "VALUE"
            },
            "value": {
              "type": "number"
            }
          }
        }
      ]
    },
    "dataMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "DATA"
            },
            "field": {
              "type": "string"
            }
          }
        }
      ]
    },
    "maMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "enum": [
                "SMA",
                "EMA",
                "RMA",
                "WMA",
                "HMA"
              ]
            },
            "period": {
              "type": "number"
            },
            "source": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "rsiMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "RSI"
            },
            "period": {
              "type": "number"
            },
            "source": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "atrMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "ATR"
            },
            "period": {
              "type": "number"
            },
            "maSmoothingType": {
              "enum": [
                "SMA",
                "EMA",
                "RMA",
                "WMA",
                "HMA"
              ]
            }
          }
        }
      ]
    },
    "stddevMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "STDDEV"
            },
            "period": {
              "type": "integer"
            },
            "source": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "bbMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "BB"
            },
            "maType": {
              "enum": [
                "SMA",
                "EMA",
                "RMA",
                "WMA",
                "HMA"
              ]
            },
            "period": {
              "type": "number"
            },
            "stddev": {
              "type": "number"
            },
            "maSource": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "kcMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "KC"
            },
            "maSource": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "maPeriod": {
              "type": "integer"
            },
            "maMethodType": {
              "enum": [
                "SMA",
                "EMA",
                "RMA",
                "WMA",
                "HMA"
              ]
            },
            "bandMethodType": {
              "enum": [
                "ATR",
                "TR",
                "RangeHighLow"
              ]
            },
            "bandAtrPeriod": {
              "type": "integer"
            },
            "multiplier": {
              "type": "number"
            }
          }
        }
      ]
    },
    "macdMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "MACD"
            },
            "fast": {
              "type": "number"
            },
            "slow": {
              "type": "number"
            },
            "signal": {
              "type": "number"
            },
            "source": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "stochMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "STOCH"
            },
            "kPeriod": {
              "type": "number"
            },
            "kSmooth": {
              "type": "number"
            },
            "dPeriod": {
              "type": "number"
            },
            "high": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "low": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "close": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "stochRsiMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "STOCH_RSI"
            },
            "kPeriod": {
              "type": "number"
            },
            "kSmooth": {
              "type": "number"
            },
            "dPeriod": {
              "type": "number"
            },
            "rsiInput": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "rsiPeriod": {
              "type": "number"
            }
          }
        }
      ]
    },
    "addMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "ADD"
            },
            "augend": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "addend": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "subtractMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "SUBTRACT"
            },
            "minuend": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "subtrahend": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "multiplyMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "MULTIPLY"
            },
            "multiplicand": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "multiplier": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "divideMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "DIVIDE"
            },
            "dividend": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "divisor": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "negateMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "NEGATE"
            },
            "operand": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "sqrtMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "SQRT"
            },
            "operand": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "changeMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "CHANGE"
            },
            "source": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "absDiffMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "ABS_DIFF"
            },
            "minuend": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "subtrahend": {
              "$ref": "#/definitions/methodAsParameter"
            }
          }
        }
      ]
    },
    "percentageMethod": {
      "allOf": [
        {
          "$ref": "#/definitions/baseMethod"
        },
        {
          "properties": {
            "method": {
              "const": "PERCENTAGE"
            },
            "base": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "percentage": {
              "type": "number"
            }
          }
        }
      ]
    },
    "method": {
      "oneOf": [
        {
          "$ref": "#/definitions/referenceMethod"
        },
        {
          "$ref": "#/definitions/selectOutputMethod"
        },
        {
          "$ref": "#/definitions/lookbackMethod"
        },
        {
          "$ref": "#/definitions/quoteMethod"
        },
        {
          "$ref": "#/definitions/valueMethod"
        },
        {
          "$ref": "#/definitions/dataMethod"
        },
        {
          "$ref": "#/definitions/maMethod"
        },
        {
          "$ref": "#/definitions/rsiMethod"
        },
        {
          "$ref": "#/definitions/atrMethod"
        },
        {
          "$ref": "#/definitions/stddevMethod"
        },
        {
          "$ref": "#/definitions/bbMethod"
        },
        {
          "$ref": "#/definitions/kcMethod"
        },
        {
          "$ref": "#/definitions/macdMethod"
        },
        {
          "$ref": "#/definitions/stochMethod"
        },
        {
          "$ref": "#/definitions/stochRsiMethod"
        },
        {
          "$ref": "#/definitions/addMethod"
        },
        {
          "$ref": "#/definitions/subtractMethod"
        },
        {
          "$ref": "#/definitions/multiplyMethod"
        },
        {
          "$ref": "#/definitions/divideMethod"
        },
        {
          "$ref": "#/definitions/negateMethod"
        },
        {
          "$ref": "#/definitions/sqrtMethod"
        },
        {
          "$ref": "#/definitions/changeMethod"
        },
        {
          "$ref": "#/definitions/absDiffMethod"
        },
        {
          "$ref": "#/definitions/percentageMethod"
        }
      ]
    },
    "filterAsParameter": {
      "oneOf": [
        {
          "$ref": "#/definitions/filter"
        },
        {
          "type": "boolean"
        }
      ]
    },
    "baseFilter": {
      "type": "object",
      "properties": {
        "filter": {
          "type": "string"
        }
      },
      "required": [
        "filter"
      ]
    },
    "compositeConditionFilter": {
      "allOf": [
        {
          "$ref": "#/definitions/baseFilter"
        },
        {
          "properties": {
            "filter": {
              "enum": [
                "ALL_OF",
                "ANY_OF"
              ]
            },
            "conditions": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/filterAsParameter"
              }
            }
          },
          "required": [
            "conditions"
          ]
        }
      ]
    },
    "comparisonFilter": {
      "allOf": [
        {
          "$ref": "#/definitions/baseFilter"
        },
        {
          "properties": {
            "filter": {
              "enum": [
                "LESS_THAN",
                "LESS_EQUAL",
                "GREATER_THAN",
                "GREATER_EQUAL",
                "EQUAL",
                "NOT_EQUAL"
              ]
            },
            "target": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "threshold": {
              "$ref": "#/definitions/methodAsParameter"
            }
          },
          "required": [
            "target",
            "threshold"
          ]
        }
      ]
    },
    "crossFilter": {
      "allOf": [
        {
          "$ref": "#/definitions/baseFilter"
        },
        {
          "properties": {
            "filter": {
              "enum": [
                "CROSSOVER",
                "CROSSUNDER"
              ]
            },
            "signal": {
              "$ref": "#/definitions/methodAsParameter"
            },
            "reference": {
              "$ref": "#/definitions/methodAsParameter"
            }
          },
          "required": [
            "signal",
            "reference"
          ]
        }
      ]
    },
    "booleanFilter": {
      "allOf": [
        {
          "$ref": "#/definitions/baseFilter"
        },
        {
          "properties": {
            "filter": {
              "enum": [
                "TRUE",
                "FALSE"
              ]
            }
          }
        }
      ]
    },
    "binaryLogicalFilter": {
      "allOf": [
        {
          "$ref": "#/definitions/baseFilter"
        },
        {
          "properties": {
            "filter": {
              "enum": [
                "AND",
                "OR",
                "XOR"
              ]
            },
            "firstCondition": {
              "$ref": "#/definitions/filterAsParameter"
            },
            "secondCondition": {
              "$ref": "#/definitions/filterAsParameter"
            }
          },
          "required": [
            "firstCondition",
            "secondCondition"
          ]
        }
      ]
    },
    "unaryLogicalFilter": {
      "allOf": [
        {
          "$ref": "#/definitions/baseFilter"
        },
        {
          "properties": {
            "filter": {
              "enum": [
                "NOT"
              ]
            },
            "condition": {
              "$ref": "#/definitions/filterAsParameter"
            }
          },
          "required": [
            "condition"
          ]
        }
      ]
    },
    "filter": {
      "oneOf": [
        {
          "$ref": "#/definitions/crossFilter"
        },
        {
          "$ref": "#/definitions/compositeConditionFilter"
        },
        {
          "$ref": "#/definitions/comparisonFilter"
        },
        {
          "$ref": "#/definitions/booleanFilter"
        },
        {
          "$ref": "#/definitions/binaryLogicalFilter"
        },
        {
          "$ref": "#/definitions/unaryLogicalFilter"
        }
      ]
    }
  }
}